generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String  @id @default(uuid())
  email     String  @unique
  password  String?
  username  String
  avatarUrl String?
  role      Role    @default(USER)

  googleId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  comments      Comment[]
  favorites     Favorite[]
  refreshTokens RefreshToken[]

  @@map("users")
}

model Anime {
  id            String  @id @default(uuid())
  title         String
  titleOriginal String?
  slug          String  @unique
  description   String? @db.Text
  posterUrl     String?
  bannerUrl     String?
  episodesCount Int     @default(0)
  views         Int     @default(0)

  genres Genre[]
  tags   Tag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  episodes  Episode[]
  comments  Comment[]
  favorites Favorite[]

  @@index([title])
  @@map("anime")
}

model Episode {
  id       String  @id @default(uuid())
  animeId  String
  number   Int
  title    String?
  duration Int?
  views    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  anime          Anime          @relation(fields: [animeId], references: [id], onDelete: Cascade)
  videoQualities VideoQuality[]

  @@unique([animeId, number])
  @@index([animeId])
  @@map("episodes")
}

model VideoQuality {
  id        String           @id @default(uuid())
  episodeId String
  quality   VideoQualityType
  hlsUrl    String
  fileSize  BigInt?

  createdAt DateTime @default(now())

  episode Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)

  @@unique([episodeId, quality])
  @@index([episodeId])
  @@map("video_qualities")
}

model Comment {
  id        String  @id @default(uuid())
  userId    String
  animeId   String
  content   String  @db.Text
  isDeleted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)

  @@index([animeId])
  @@index([userId])
  @@index([createdAt])
  @@map("comments")
}

model Favorite {
  id      String @id @default(uuid())
  userId  String
  animeId String

  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)

  @@unique([userId, animeId])
  @@index([userId])
  @@map("favorites")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}
